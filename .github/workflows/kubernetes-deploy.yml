# .github/workflows/kubernetes-deploy.yml
# Kubernetes GitOps Deployment Pipeline
# Author: QurolVoV — 100% solo developer

name: Kubernetes Deploy

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: read
  packages: read

jobs:
  deploy-to-k8s:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract tag name
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Configure kubeconfig (DigitalOcean / GKE / AKS / Kind / Minikube)
        env:
          kubectl config use-context your-cluster-context
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}  # Base64 dari ~/.kube/config

      - name: Deploy with Kustomize (auto update image tag)
        run: |
          cd k8s
          kustomize edit set image ghcr.io/qurolvov/phoenix-evasion-research=ghcr.io/qurolvov/phoenix-evasion-research:${{ steps.tag.outputs.tag }}
          kustomize build . | kubectl apply -f -
          kubectl rollout status deployment/phoenix-research --timeout=300s

      - name: Success Notification
        run: |
          echo "Phoenix-Evasion-Research v${{ steps.tag.outputs.tag }} berhasil di-deploy!"
          echo "Author: QurolVoV — 100% buatan sendiri"
