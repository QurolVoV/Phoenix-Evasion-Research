# .github/workflows/kubernetes-deploy.yml (Fixed Kustomize & Kind)
# Author: QurolVoV 

name: Kubernetes Deploy (Fixed)

on:
  push:
    tags: [ "v*.*.*" ]
  workflow_dispatch:

jobs:
  k8s-deploy-test:
    name: Deploy to Kind (Ephemeral CI Test)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract tag
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Setup Kind Cluster
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: phoenix-lab
          version: v0.24.0
          wait: 120s

      - name: Install yq (untuk manual patch, fix kustomize edit issues)
        run: |
          sudo snap install yq  # Stable 2025

      - name: Patch kustomization.yaml manually (no edit command)
        run: |
          cd k8s
          yq e '.images[0].newTag = "${{ steps.tag.outputs.tag }}"' -i kustomization.yaml

      - name: Deploy with kubectl (simple, no kustomize edit)
        run: |
          cd k8s
          kubectl apply -k .  # Direct kustomize build via kubectl
          kubectl rollout status deployment/phoenix-research --timeout=180s
          kubectl get pods -l app=phoenix-research

      - name: Verify
        run: |
          kubectl get svc phoenix-research-svc
          echo "Deploy OK! Pod running in Kind cluster."
