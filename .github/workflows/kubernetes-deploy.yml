# .github/workflows/kubernetes-deploy.yml
# Kubernetes GitOps Deployment Pipeline (Fixed for Kind + Kustomize)
# Author: QurolVoV

name: Kubernetes Deploy

on:
  push:
    tags: [ "v*.*.*" ]
  workflow_dispatch:  # Manual trigger untuk test

permissions:
  contents: read
  packages: read

jobs:
  deploy-to-k8s:
    name: Deploy to Kubernetes (Kind Test Cluster)
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract tag name
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Install kubectl & kustomize
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'  # Stable 2025

      - name: Install kustomize (fixed version)
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Setup Kind cluster (ephemeral for CI test)
        uses: helm/kind-action@v1.10.0  # Auto create Kind cluster
        with:
          cluster_name: phoenix-lab
          version: v0.24.0
          wait: 120s  # Wait 2 min for stability

      - name: Configure kubeconfig from secret (fixed decode)
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        run: |
          # Decode base64 & fix newlines
          echo $KUBE_CONFIG_DATA | base64 -d > /tmp/kubeconfig
          sed -i 's/\\n/\n/g' /tmp/kubeconfig  # Fix escaped newlines
          export KUBECONFIG=/tmp/kubeconfig
          echo "KUBECONFIG=/tmp/kubeconfig" >> $GITHUB_ENV
          kubectl cluster-info  # Test connection

      - name: Update & Deploy with Kustomize (fixed image tag)
        run: |
          cd k8s
          # Backup original kustomization.yaml
          cp kustomization.yaml kustomization.yaml.bak
          
          # Try edit image tag (with error handling)
          kustomize edit set image ghcr.io/qurolvov/phoenix-evasion-research=ghcr.io/qurolvov/phoenix-evasion-research:${{ steps.tag.outputs.tag }} || {
            echo "Edit failed, using build instead"
            # Fallback: manual patch
            sed -i "s/newTag: latest/newTag: ${{ steps.tag.outputs.tag }}/" kustomization.yaml
          }
          
          # Build & apply
          kustomize build . | kubectl apply -f -
          kubectl rollout status deployment/phoenix-research --timeout=300s || echo "Rollout warning: may be normal in CI"

      - name: Verify deployment
        run: |
          kubectl get pods -l app=phoenix-research
          kubectl get svc phoenix-research-svc
          echo "Deployment successful! Check logs for details."

      - name: Cleanup (optional)
        if: always()
        run: |
          kind delete cluster --name phoenix-lab || true
