# .github/workflows/ci-cd.yml
# Phoenix-Evasion-Research Framework — Full CI/CD 2025 + Windows Support
# Author: QurolVoV (100% solo developer — no external help)

name: CI/CD

on:
  push:
    branches: [ main, develop ]
    tags: [ "v*.*.*" ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ==================== LINUX / MACOS CI ====================
  linux-tests:
    name: "Linux Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Lint & Type Check
        run: |
          ruff check .
          black --check --diff .
          mypy .

      - name: Run Tests (Linux)
        run: |
          pytest tests/ --cov=phoenix_evasion_research --cov-report=term-missing

  # ==================== WINDOWS-SPECIFIC CI ====================
  windows-tests:
    name: "Windows Tests (Core Platform)"
    runs-on: windows-latest
    timeout-minutes: 20
    needs: linux-tests  # Hanya jalan jika Linux lulus (hemat quota)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: x64
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Verify Windows-only imports
        run: |
          python -c "import ctypes, winreg, psutil; print('Windows modules OK')"

      - name: Run full test suite on Windows
        run: |
          pytest tests/ `
            --cov=phoenix_evasion_research `
            --cov-report=xml `
            --cov-report=term-missing `
            -n auto `
            --durations=10

      - name: Windows-specific evasion research tests
        run: |
          python -c "
from phoenix_evasion_research import HadesSyscallEngine, SecurityEvasion
engine = HadesSyscallEngine()
ssn = engine.get_syscall_number('NtCreateThreadEx')
print(f'NtCreateThreadEx SSN on Windows: {ssn}')
ev = SecurityEvasion()
ev.execute_evasion()
print('Windows anti-analysis checks passed')
          "

      - name: Upload Windows coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: windows
          name: windows-coverage

  # ==================== SECURITY & RELEASE ====================
  security-and-release:
    name: Security Scan & Release
    needs: [linux-tests, windows-tests]
    if: success()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Security Scan (Bandit + Semgrep)
        run: |
          pip install bandit semgrep
          bandit -r . -c pyproject.toml
          semgrep ci --config p/security-audit

      - name: Build & Release (only on tag)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          pip install build twine
          python -m build
          twine check dist/*
          
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: ncipollo/release-action@v1
        with:
          generateReleaseNotes: true
          artifacts: "dist/*"

      - name: Final Status
        run: |
          echo "CI/CD selesai oleh QurolVoV"
          echo "100% buatan sendiri — tanpa bantuan orang lain"
          echo "Windows + Linux tests: PASSED"
