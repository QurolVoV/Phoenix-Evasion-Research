version: '3.9'

# Phoenix-Evasion-Research Framework
# Docker Compose configuration for development and production

services:
  # Development service
  phoenix-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: phoenix-evasion-dev
    image: phoenix-evasion-research:dev
    volumes:
      - .:/app
      - /app/__pycache__
    working_dir: /app
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    command: python -m src.phoenix_evasion_research --target https://example.com
    networks:
      - phoenix-net
    restart: no

  # Production service
  phoenix-prod:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VERSION: "1.0.0"
        BUILD_DATE: "2025-01-26"
        VCS_REF: "main"
    container_name: phoenix-evasion-prod
    image: phoenix-evasion-research:latest
    environment:
      - PYTHONUNBUFFERED=1
    command: ["--target", "https://example.com", "--quick"]
    networks:
      - phoenix-net
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /app

  # Testing service
  phoenix-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: phoenix-evasion-test
    image: phoenix-evasion-research:test
    volumes:
      - .:/app
      - /app/__pycache__
    working_dir: /app
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    command: pytest tests/ -v --cov=src --cov-report=term-missing
    networks:
      - phoenix-net
    restart: no

  # Security scanning service
  phoenix-security:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: phoenix-evasion-security
    image: phoenix-evasion-research:security
    volumes:
      - .:/app
    working_dir: /app
    environment:
      - PYTHONUNBUFFERED=1
    command: >
      bash -c "
        echo '=== Running Security Scans ===' &&
        echo 'Bandit Security Scan:' &&
        bandit -r src/ &&
        echo '\nSafety Check:' &&
        safety check
      "
    networks:
      - phoenix-net
    restart: no

networks:
  phoenix-net:
    driver: bridge
    name: phoenix-network

volumes:
  phoenix-cache:
    driver: local
